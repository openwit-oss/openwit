environment: "production"

deployment:
  mode: "local"

control_plane:
  grpc_endpoint: "${CONTROL_PLANE_GRPC_ENDPOINT:-http://localhost:7019}"

ingestion:
  sources:
    kafka:
      enabled: true
    grpc:
      enabled: true
    http:
      enabled: false

  kafka:
    brokers: "${KAFKA_BROKERS:-localhost:9092}"
    group_id: "${KAFKA_GROUP_ID:-openwit-ingestion-group}"
    topics:
      - "${KAFKA_TOPICS:-v6.qtw.traces.*.*}"
    consumer_type: "standard"

    high_performance:
      num_consumers: 2
      processing_threads: 4
      num_grpc_clients: 2
      channel_buffer_size: 10000

      fetch_min_bytes: 262144
      fetch_max_bytes: 8388608
      max_partition_fetch_bytes: 2097152

      enable_zero_copy: true
      zero_copy_threshold_bytes: 102400
      preallocate_buffers: false
      buffer_pool_size: 100

    topic_index_config:
      default_index_position: 3

      patterns:
        - match: "v6.qtw.*.*.*"
          index_position: 3

      auto_generate:
        enabled: false
        prefix: "auto_"
        strategy: "hash"

    consumer:
      session_timeout_ms: 180000
      heartbeat_interval_ms: 3000
      max_poll_interval_ms: 900000
      max_poll_records: 50000

    commit_strategy:
      mode: "after_wal"
      enable_auto_commit: false
      wait_for_wal: true
      wal_timeout_ms: 10000
      retry_on_failure: true
      max_retries: 3

    batching:
      batch_size: 100
      batch_timeout_ms: 100

  batch_tracker:
    enabled: true
    postgres_url: "${POSTGRES_URL:-postgresql://postgres:password@localhost:5432/openwit}"
    batch_config:
      max_size_bytes: 10485760
      max_messages: 10000
      max_age_seconds: 30

    wal_directory: "./data/wal"

  telemetry_type: "traces"

  performance:
    use_direct_conversion: true
    preallocate_capacity: 1000
    zero_copy: true
    parallel_processing: true
    workers: 8

  batch_processing:
    maintain_kafka_batch_id: true
    process_as_batch: true
    batch_size: 100
    batch_timeout_ms: 100
    track_per_batch_metrics: true

  grpc:
    bind: "0.0.0.0"
    port: 50051
    max_message_size: 208715200

    tls:
      enabled: false
      cert_path: "${TLS_CERT_PATH:-}"
      key_path: "${TLS_KEY_PATH:-}"

  http:
    port: 4318
    max_concurrent_requests: 5000
    request_timeout_ms: 30000
    max_payload_size_mb: 100

  otlp_batching:
    enabled: true
    max_spans_per_batch: 10000
    max_batch_bytes: 50000000
    flush_interval_secs: 5
    max_messages_per_batch: 1000

# gRPC/HTTP ingestion batching configuration
processing:
  buffer:
    flush_size_messages: 5000
    flush_interval_seconds: 20

storage:
  backend: "local"
  data_dir: "/openwit/data/storage"
  parquet_split_size_mb: 500

  local:
    enabled: true
    path: "/openwit/data/storage"
    max_disk_usage_percent: 80
    cleanup_interval_seconds: 3600

  azure:
    enabled: false
    account_name: "${AZURE_STORAGE_ACCOUNT:-}"
    container_name: "${AZURE_STORAGE_CONTAINER:-}"
    access_key: "${AZURE_STORAGE_ACCESS_KEY:-}"
    prefix: "openwit/storage"
    endpoint: "${AZURE_STORAGE_ENDPOINT:-}"

  s3:
    enabled: false
    bucket: "${S3_BUCKET_NAME:-}"
    region: "${S3_REGION:-}"
    access_key_id: "${AWS_ACCESS_KEY_ID:-}"
    secret_access_key: "${AWS_SECRET_ACCESS_KEY:-}"
    prefix: "openwit/storage"

  gcs:
    enabled: false
    bucket: "${GCS_BUCKET_NAME:-}"
    service_account_key: "${GCS_SERVICE_ACCOUNT_KEY:-}"

  parquet:
    row_group_size: 1000000
    compression_codec: "zstd"
    compression_level: 3
    enable_statistics: true
    data_page_size_kb: 1024

  write_buffer:
    max_rows: 50000
    flush_interval_secs: 30
    max_memory_mb: 512

  partitioning:
    enabled: true
    structure: "year/month/day"

  file_rotation:
    file_size_mb: 256
    file_duration_minutes: 60
    idle_timeout_minutes: 5
    enable_active_stable_files: true
    upload_delay_minutes: 2

  local_retention:
    retention_days: 7
    cleanup_interval_hours: 1
    delete_after_upload: false

  performance:
    max_concurrent_batches: 8
    metadata_cache_ttl_secs: 600
    query_cache_ttl_secs: 300


storage_node:
  grpc:
    bind_addr: "0.0.0.0:8082"
  flight:
    bind_addr: "0.0.0.0:9401"
  cache:
    max_size_mb: 1024
    ttl_seconds: 3600

networking:
  service_endpoints:
    control_plane: "http://localhost:7019"
    storage: "http://localhost"
    ingestion: "http://localhost"
    indexer: "http://localhost"
    search: "http://localhost:8083"

  inter_node:
    connection_timeout_ms: 5000
    request_timeout_ms: 30000
    max_connections_per_node: 10
    keepalive_interval_ms: 10000


memory:
  max_memory_gb: 32

metastore:
  backend: "sled"

  sled:
    path: "./data/metastore"
    cache_size_mb: 512

  postgres:
    connection_string: "${DATABASE_URL:-}"
    max_connections: 20

indexing:
  enabled: true
  batch_size: 1000
  worker_threads: 4

search:
  enabled: true
  max_results: 1000

janitor:
  cleanup_interval_seconds: 3600
  retention_days: 30

development:
  skip_health_checks: false

performance_testing:
  enabled: false

service_ports:
  control_plane:
    service: 7019
  storage:
    service: 8081
    arrow_flight: 9401
  ingestion:
    grpc: 50051
    http: 4318
    arrow_flight: 8089
  indexer:
    service: 8085
    arrow_flight: 8090
  proxy:
    service: 8080
  search:
    service: 8083
    grpc: 50059
